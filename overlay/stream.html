<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AI plays DCSS</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0a;
    font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
    color: #e0e0e0;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  .layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    grid-template-rows: 1fr auto;
    height: 100vh;
    gap: 0;
  }

  /* === Game panel (top-left) === */
  .game-panel {
    grid-row: 1 / 3;
    grid-column: 1;
    background: #000;
    position: relative;
    overflow: hidden;
  }
  .game-panel iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* === Right column === */
  .right-col {
    grid-row: 1 / 3;
    grid-column: 2;
    display: flex;
    flex-direction: column;
    border-left: 2px solid #1a1a1a;
    background: #0d0d0d;
  }

  /* === Stats bar (top of right col) === */
  .stats-bar {
    padding: 16px 20px;
    background: #111;
    border-bottom: 1px solid #222;
    flex-shrink: 0;
  }
  .stats-title {
    font-size: 18px;
    font-weight: 700;
    color: #ffcc00;
    margin-bottom: 12px;
    letter-spacing: 1px;
  }
  .stats-title .emoji { margin-right: 6px; }
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .stat-card {
    background: #1a1a1a;
    border-radius: 6px;
    padding: 8px 12px;
    text-align: center;
  }
  .stat-card.wide {
    grid-column: 1 / -1;
  }
  .stat-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #666;
    margin-bottom: 2px;
  }
  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: #fff;
    font-family: 'Courier New', monospace;
  }
  .stat-value.attempt { color: #ffcc00; }
  .stat-value.wins { color: #4caf50; }
  .stat-value.deaths { color: #f44336; }
  .stat-value.char { color: #64b5f6; font-size: 14px; }
  .stat-value.place { color: #ffab40; font-size: 16px; }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
  }
  .stat-row .stat-label { margin-bottom: 0; }
  .stat-row .stat-value { font-size: 14px; }

  .divider {
    border-top: 1px solid #222;
    margin: 10px 0;
  }

  /* === Monologue feed (fills rest of right col) === */
  .monologue-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
  }
  .monologue-header {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #555;
    padding: 12px 20px 8px;
    flex-shrink: 0;
  }
  .monologue-feed {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px 16px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    scrollbar-width: thin;
    scrollbar-color: #333 transparent;
  }
  .monologue-feed::-webkit-scrollbar { width: 4px; }
  .monologue-feed::-webkit-scrollbar-track { background: transparent; }
  .monologue-feed::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .thought {
    background: #151515;
    border-left: 3px solid #333;
    border-radius: 0 6px 6px 0;
    padding: 10px 14px;
    margin-top: 8px;
    font-size: 13px;
    line-height: 1.6;
    color: #999;
    animation: slideIn 0.4s ease-out;
    transition: all 0.3s ease;
  }
  .thought:last-child {
    border-left-color: #ffcc00;
    color: #ddd;
    background: #1a1a0a;
  }
  .thought .ts {
    font-size: 10px;
    color: #444;
    font-family: 'Courier New', monospace;
    margin-bottom: 4px;
  }
  .thought .text {
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .thought:last-child .text::after {
    content: '';
    display: inline-block;
    width: 7px;
    height: 13px;
    background: #ffcc00;
    margin-left: 2px;
    vertical-align: text-bottom;
    animation: blink 1s step-end infinite;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes blink {
    50% { opacity: 0; }
  }
</style>
</head>
<body>
<div class="layout">

  <!-- Game view -->
  <div class="game-panel">
    <iframe id="game" src="http://moltbot.story-nessie.ts.net:8080/#watch-dcssai"></iframe>
  </div>

  <!-- Right column: stats + monologue -->
  <div class="right-col">

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stats-title"><span class="emoji">ðŸ¤–</span>AI plays DCSS</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Game</div>
          <div class="stat-value attempt" id="attempt">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Win / Death</div>
          <div class="stat-value">
            <span class="wins" id="wins">0</span>
            <span style="color:#444"> / </span>
            <span class="deaths" id="deaths">0</span>
          </div>
        </div>
        <div class="stat-card wide">
          <div class="stat-label">Character</div>
          <div class="stat-value char" id="character">â€”</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="stat-row">
        <span class="stat-label">Location</span>
        <span class="stat-value place" id="place">â€”</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">XL</span>
        <span class="stat-value" id="xl">â€”</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Turn</span>
        <span class="stat-value" id="turn">â€”</span>
      </div>
    </div>

    <!-- Monologue -->
    <div class="monologue-section">
      <div class="monologue-header">ðŸ’­ AI Thoughts</div>
      <div class="monologue-feed" id="feed"></div>
    </div>

  </div>
</div>

<script>
const MAX_THOUGHTS = 20;
let thoughts = [];
let renderedCount = 0;

// SSE port â€” same as driver's overlay_port config
const SSE_PORT = 8889;
const SSE_URL = location.protocol + '//' + location.hostname + ':' + SSE_PORT + '/events';

function reloadGameIframe(delayMs = 0) {
  setTimeout(() => {
    const panel = document.querySelector('.game-panel');
    const old = document.getElementById('game');
    if (old) old.remove();
    const iframe = document.createElement('iframe');
    iframe.id = 'game';
    iframe.src = 'http://moltbot.story-nessie.ts.net:8080/#watch-dcssai';
    panel.appendChild(iframe);
  }, delayMs);
}

function updateStatsUI(d) {
  document.getElementById('attempt').textContent = d.attempt || '\u2014';
  document.getElementById('wins').textContent = d.wins || 0;
  document.getElementById('deaths').textContent = d.deaths || 0;
  document.getElementById('character').textContent = d.character || '\u2014';
  document.getElementById('xl').textContent = d.xl || '\u2014';
  document.getElementById('place').textContent = d.place || '\u2014';
  document.getElementById('turn').textContent = d.turn || '\u2014';
}

function addThought(entry) {
  thoughts.push(entry);
  if (thoughts.length > MAX_THOUGHTS) {
    thoughts = thoughts.slice(-MAX_THOUGHTS);
    // Force full re-render when we slice
    renderedCount = 0;
    renderFeed(true);
  } else {
    renderFeed();
  }
}

function renderFeed(reset) {
  const feed = document.getElementById('feed');

  if (reset) {
    feed.innerHTML = '';
    renderedCount = 0;
  }

  if (renderedCount >= thoughts.length) return;

  // Build new elements off-DOM to avoid reflow flicker
  const frag = document.createDocumentFragment();
  for (let i = renderedCount; i < thoughts.length; i++) {
    const t = thoughts[i];
    const div = document.createElement('div');
    div.className = 'thought';

    const ts = new Date(t.ts * 1000);
    const timeStr = ts.toLocaleTimeString('en-US', {
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    });

    let text = t.text.trim().replace(/\n{3,}/g, '\n\n');

    div.innerHTML = '<div class="ts">' + timeStr + '</div><div class="text">' + esc(text) + '</div>';
    frag.appendChild(div);
  }

  // Single DOM operation â€” append all at once
  feed.appendChild(frag);
  renderedCount = thoughts.length;
  feed.scrollTop = feed.scrollHeight;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// --- SSE Connection ---
function connectSSE() {
  const es = new EventSource(SSE_URL);
  
  es.addEventListener('stats', (e) => {
    try { updateStatsUI(JSON.parse(e.data)); } catch(err) {}
  });

  es.addEventListener('thought', (e) => {
    try { addThought(JSON.parse(e.data)); } catch(err) {}
  });

  es.addEventListener('reset', () => {
    thoughts = [];
    renderedCount = 0;
    renderFeed(true);
  });

  es.addEventListener('game_started', () => {
    reloadGameIframe(500);
  });

  es.onerror = () => {
    // EventSource auto-reconnects, but log it
    console.warn('SSE connection lost, reconnecting...');
  };

  return es;
}

connectSSE();
</script>
</body>
</html>
